name: Dependency Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run dependency checks weekly on Mondays at 10 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  npm-audit:
    name: NPM Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NestSync-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd NestSync-frontend
          npm ci --legacy-peer-deps

      - name: Run npm audit
        id: npm-audit
        run: |
          cd NestSync-frontend
          # Generate JSON report
          npm audit --json > npm-audit.json || true

          # Parse results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "### NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ **Critical**: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  **High**: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ **Moderate**: $MODERATE" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”µ **Low**: $LOW" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate human-readable report
          npm audit > npm-audit-report.txt || true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-results
          path: |
            NestSync-frontend/npm-audit.json
            NestSync-frontend/npm-audit-report.txt
          retention-days: 30

      - name: Check for critical vulnerabilities
        if: steps.npm-audit.outputs.critical > 0
        run: |
          echo "::error::Found ${{ steps.npm-audit.outputs.critical }} critical vulnerabilities in npm dependencies"
          echo "Please review and fix critical vulnerabilities before merging"
          exit 1

  pip-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: NestSync-backend/requirements.txt

      - name: Install dependencies
        run: |
          cd NestSync-backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit safety

      - name: Run pip-audit
        id: pip-audit
        run: |
          cd NestSync-backend
          # Generate JSON report
          pip-audit --format json > pip-audit.json || true

          # Count vulnerabilities
          if [ -f pip-audit.json ]; then
            VULN_COUNT=$(jq '.dependencies | length' pip-audit.json || echo "0")
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT

            echo "### pip-audit Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ **Vulnerabilities Found**: $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Generate human-readable report
          pip-audit --format text > pip-audit-report.txt || true

      - name: Run Safety check
        id: safety
        run: |
          cd NestSync-backend
          # Generate JSON report
          safety check --json > safety-report.json || true

          # Parse results
          if [ -f safety-report.json ]; then
            SAFETY_ISSUES=$(jq 'length' safety-report.json || echo "0")
            echo "issues=$SAFETY_ISSUES" >> $GITHUB_OUTPUT

            echo "### Safety Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ›¡ï¸ **Security Issues**: $SAFETY_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Generate human-readable report
          safety check > safety-report.txt || true

      - name: Upload pip audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-results
          path: |
            NestSync-backend/pip-audit.json
            NestSync-backend/pip-audit-report.txt
            NestSync-backend/safety-report.json
            NestSync-backend/safety-report.txt
          retention-days: 30

      - name: Comment PR with vulnerabilities
        if: github.event_name == 'pull_request' && (steps.pip-audit.outputs.vulnerabilities > 0 || steps.safety.outputs.issues > 0)
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## Python Dependency Security Issues\n\n';
            comment += `- pip-audit found: ${{ steps.pip-audit.outputs.vulnerabilities }} vulnerabilities\n`;
            comment += `- safety found: ${{ steps.safety.outputs.issues }} security issues\n\n`;
            comment += 'Please review the artifacts for detailed reports.\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: true

  outdated-dependencies:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: NestSync-frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check outdated npm packages
        run: |
          cd NestSync-frontend
          npm outdated > npm-outdated.txt || true

          echo "### Outdated NPM Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat npm-outdated.txt >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Check outdated pip packages
        run: |
          cd NestSync-backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip list --outdated > pip-outdated.txt || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outdated Python Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat pip-outdated.txt >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload outdated package reports
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages
          path: |
            NestSync-frontend/npm-outdated.txt
            NestSync-backend/pip-outdated.txt
          retention-days: 30

  dependency-summary:
    name: Dependency Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, pip-audit]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "### Dependency Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Job Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Audit: ${{ needs.pip-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.npm-audit.result }}" == "success" ] && \
             [ "${{ needs.pip-audit.result }}" == "success" ]; then
            echo "All dependency security checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some dependency security checks failed. Please review and address vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi
