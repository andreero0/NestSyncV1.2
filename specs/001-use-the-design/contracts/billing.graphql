# GraphQL Schema Contract: Billing & Invoices
# Feature: Premium Upgrade Flow
# Date: 2025-10-02

"""
Billing history record with Canadian tax compliance.
Immutable record of subscription charges, invoices, and refunds.
"""
type BillingRecord {
  id: ID!
  subscriptionId: ID!
  userId: ID!
  
  # Invoice Details
  stripeInvoiceId: String!
  stripePaymentIntentId: String
  invoiceNumber: String!  # Canadian-compliant numbering
  
  # Amounts (in dollars, stored as cents in database)
  subtotal: Float!
  taxAmount: Float!
  total: Float!
  currency: String!
  
  # Tax Breakdown
  province: CanadianProvince!
  provinceName: String!
  gstAmount: Float
  pstAmount: Float
  hstAmount: Float
  qstAmount: Float
  taxBreakdown: TaxBreakdown!
  
  # Payment Status
  status: InvoiceStatus!
  paidAt: DateTime
  
  # Billing Period
  periodStart: DateTime!
  periodEnd: DateTime!
  
  # Canadian Tax Compliance
  businessNumber: String
  gstRegistration: String  # GST/HST registration number
  
  # Documents (Stripe-hosted PDFs)
  invoicePdfUrl: String
  receiptPdfUrl: String
  
  # Refunds
  refundedAt: DateTime
  refundAmount: Float
  refundReason: String
  isRefunded: Boolean!
  
  # Timestamps
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Invoice payment status"""
enum InvoiceStatus {
  DRAFT          # Invoice created but not finalized
  OPEN           # Invoice sent, payment pending
  PAID           # Payment successful
  VOID           # Invoice canceled before payment
  UNCOLLECTIBLE  # Payment failed after retries
}

# ========================================
# QUERIES
# ========================================

extend type Query {
  """
  Get billing history for current user.
  Returns all invoices sorted by date (newest first).
  Includes paid, unpaid, and voided invoices.
  """
  billingHistory(
    limit: Int = 10
    offset: Int = 0
    status: InvoiceStatus
  ): BillingHistoryConnection!
  
  """
  Get specific invoice by ID.
  Returns full invoice details with tax breakdown and PDF URLs.
  """
  invoice(id: ID!): BillingRecord
  
  """
  Get upcoming invoice preview.
  Shows what next charge will be before it's processed.
  Useful for plan change previews and proration calculations.
  """
  upcomingInvoice: UpcomingInvoice
  
  """
  Download invoice PDF.
  Returns temporary signed URL for PDF download (expires in 1 hour).
  
  Requirements:
  - Invoice must belong to current user
  - PDF must be generated by Stripe
  """
  downloadInvoice(invoiceId: ID!): DownloadResult!
  
  """
  Get billing summary for current subscription.
  Aggregate metrics: total spent, average monthly cost, payment success rate.
  Used for subscription management dashboard.
  """
  billingSummary: BillingSummary!
}

"""Paginated billing history response"""
type BillingHistoryConnection {
  records: [BillingRecord!]!
  totalCount: Int!
  hasMore: Boolean!
  nextOffset: Int
}

"""Upcoming invoice preview (not yet charged)"""
type UpcomingInvoice {
  subtotal: Float!
  taxAmount: Float!
  total: Float!
  currency: String!
  periodStart: DateTime!
  periodEnd: DateTime!
  prorationAmount: Float  # If plan changed mid-period
  taxBreakdown: TaxBreakdown!
}

"""Invoice PDF download URL"""
type DownloadResult {
  success: Boolean!
  downloadUrl: String  # Temporary signed URL (expires in 1 hour)
  expiresAt: DateTime
  error: Error
}

"""Billing summary metrics"""
type BillingSummary {
  totalSpent: Float!
  averageMonthlySpend: Float!
  invoiceCount: Int!
  paymentSuccessRate: Float!  # Percentage of successful payments
  lastPaymentDate: DateTime
  nextPaymentDate: DateTime
  currentPeriodStart: DateTime!
  currentPeriodEnd: DateTime!
}

# ========================================
# MUTATIONS
# ========================================

extend type Mutation {
  """
  Request refund for invoice within cooling-off period.
  Full refund available for annual subscriptions within 14 days.
  Prorated refund for other cases based on usage.
  
  Requirements:
  - Invoice must belong to current user
  - Must be within refund eligibility window
  - Subscription must be in valid refund state
  
  Constitutional Alignment:
  - Principle 3: Canadian consumer protection (14-day cooling-off)
  - Principle 9: Customer-friendly policies reduce support burden
  """
  requestRefund(
    invoiceId: ID!
    reason: String!
  ): RefundResult!
  
  """
  Retry failed payment.
  Attempts to charge default payment method again.
  Used during grace period for past_due subscriptions.
  
  Requirements:
  - Invoice must be in OPEN or UNCOLLECTIBLE status
  - User must have valid payment method
  - Subscription must be in PAST_DUE status
  """
  retryPayment(invoiceId: ID!): PaymentRetryResult!
}

# ========================================
# MUTATION RESULTS
# ========================================

"""Result of refund request"""
type RefundResult {
  success: Boolean!
  refundAmount: Float
  refundedInvoice: BillingRecord
  subscriptionStatus: SubscriptionStatus
  message: String
  error: Error
}

"""Result of payment retry"""
type PaymentRetryResult {
  success: Boolean!
  invoice: BillingRecord
  subscription: Subscription
  error: Error
}

# ========================================
# CANADIAN TAX COMPLIANCE
# ========================================

"""
Invoice Numbering Format:
NS-[YEAR]-[MONTH]-[SEQUENCE]

Example: NS-2025-10-00123

Requirements:
- Sequential numbering per month
- No gaps in sequence
- Prefix identifies business (NestSync)
- Year and month for audit organization

Constitutional Alignment:
- Principle 4: PIPEDA compliance (proper business records)
- Principle 5: Transparent consent (clear invoice documentation)
"""

"""
GST/HST Registration Display:
- Business Number: 123456789 (CRA business number)
- GST/HST Registration: 123456789RT0001

Requirements:
- Display on all invoices over $30 CAD
- Required for GST/HST remittance
- Validates business legitimacy for customers

Tax Breakdown Display Example:
Subtotal:           $4.99 CAD
GST (5%):           $0.25 CAD
PST (7%):           $0.35 CAD
Total:              $5.59 CAD

Province: British Columbia
Tax Type: GST + PST
"""

# ========================================
# STRIPE WEBHOOK INTEGRATION
# ========================================

"""
Invoice Lifecycle Events (Backend Processing):

1. invoice.created
   - Create draft BillingRecord
   - Status: DRAFT

2. invoice.finalized
   - Update BillingRecord
   - Status: OPEN
   - Generate invoice number
   - Store invoice PDF URL

3. invoice.paid
   - Update BillingRecord
   - Status: PAID
   - Store payment timestamp
   - Store receipt PDF URL
   - Update subscription current_period_end

4. invoice.payment_failed
   - Update BillingRecord
   - Status: OPEN (retry scheduled)
   - Update subscription status to PAST_DUE
   - Start 3-day grace period timer

5. invoice.voided
   - Update BillingRecord
   - Status: VOID
   - Record cancellation reason

6. invoice.payment_action_required
   - Update BillingRecord
   - Send 3D Secure authentication notification

7. charge.refunded
   - Update BillingRecord
   - Record refund amount and reason
   - Update subscription if full refund

Constitutional Alignment:
- Principle 6: Documented failure prevention (webhook reliability)
- Principle 9: Four-layer defense (webhook retry logic)
"""

# ========================================
# BILLING ERROR HANDLING
# ========================================

"""
Payment Failure Recovery Flow (FR-027, FR-038, FR-039):

Day 0: Payment Fails
- Stripe webhook: invoice.payment_failed
- Subscription status: PAST_DUE
- Grace period starts: 3 days
- User notification: "Payment issue - please update card"
- Premium features: Still accessible

Day 1-3: Grace Period
- Stripe automatic retry: Smart retry schedule
- User actions available:
  * Update payment method
  * Manual payment retry
  * Cancel subscription
- Dashboard banner: "Payment issue - X days remaining"

Day 3: Grace Period Ends
- If still unpaid:
  * Subscription status: UNPAID
  * Premium features: Revoked
  * Transition to free tier
  * Data preserved (FR-040)

Recovery:
- User updates payment method
- mutation { retryPayment() }
- Success: status -> ACTIVE, features restored
- Failure: Remain UNPAID, contact support prompt

Constitutional Alignment:
- Principle 2: Stress reduction (clear error messages, multiple recovery paths)
- Principle 9: Customer-friendly grace period (3 days)
- Principle 10: Graceful degradation (data preserved)
"""

# ========================================
# REFUND POLICY
# ========================================

"""
Cooling-Off Period Refunds (FR-035):

Annual Subscriptions:
- Full refund if canceled within 14 days
- Calculated from subscription creation date
- No usage restrictions during cooling-off
- Stripe refund processed within 5-10 business days

Monthly Subscriptions:
- No cooling-off period required
- Subscription continues until period end
- No refunds (prorated cancellation)

Refund Processing:
1. User: mutation { cancelSubscription() }
2. Backend: Check cooling-off eligibility
3. If eligible: mutation { requestRefund(reason: "cooling-off") }
4. Backend: Stripe refund creation
5. Webhook: charge.refunded
6. Backend: Update billing_history, subscription status

Constitutional Alignment:
- Principle 3: Canadian consumer protection laws
- Trust-building through transparent refund policy
"""

