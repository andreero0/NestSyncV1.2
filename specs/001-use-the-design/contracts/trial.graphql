# GraphQL Schema Contract: Trial Management
# Feature: Premium Upgrade Flow
# Date: 2025-10-02

"""
Trial progress tracking with real-time value metrics.
Tracks user engagement and quantified value during 14-day trial period.
Used for conversion optimization and trial dashboard UI.
"""
type TrialProgress {
  id: ID!
  userId: ID!
  subscriptionId: ID!
  
  # Trial Period
  trialStart: DateTime!
  trialEnd: DateTime!
  daysRemaining: Int!
  percentComplete: Float!
  
  # Engagement Metrics
  featuresExplored: [String!]!
  featuresExploredCount: Int!
  totalSessions: Int!
  lastActiveAt: DateTime
  
  # Value Metrics (quantified impact)
  timeSavedMinutes: Int!
  timeSavedHours: Float!
  conflictsPrevented: Int!
  suggestionsAccepted: Int!
  automationsTriggered: Int!
  
  # Value Score (0-100 for conversion eligibility)
  valueRealizationScore: Int!
  
  # Conversion Signals
  conversionEligible: Boolean!
  conversionPromptShownAt: DateTime
  conversionPromptCount: Int!
  
  # Onboarding Progress
  onboardingCompleted: Boolean!
  onboardingStepsCompleted: [String!]!
  onboardingStepsRemaining: [OnboardingStep!]!
  
  # Timestamps
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""
Onboarding step for trial users.
Guides users through premium features during first 3 days.
"""
type OnboardingStep {
  id: String!
  title: String!
  description: String!
  featureKey: String!
  completed: Boolean!
  order: Int!
}

"""
Feature access gate based on subscription tier.
Controls premium feature availability during trial and paid subscriptions.
"""
type FeatureAccess {
  id: ID!
  userId: ID!
  featureKey: String!
  accessLevel: AccessLevel!
  
  # Trial-specific access
  trialAccess: Boolean!
  trialAccessEnds: DateTime
  
  # Usage limits (for limited access level)
  usageLimit: Int
  usageCount: Int!
  usageRemaining: Int
  
  # Expiration
  expiresAt: DateTime
  isExpired: Boolean!
  
  # Timestamps
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Access levels for premium features"""
enum AccessLevel {
  NONE     # Feature locked, upgrade prompt shown
  LIMITED  # Partial access with usage limits
  FULL     # Unlimited access
}

"""Premium features that can be gated"""
enum PremiumFeature {
  REORDER                # Automated reorder suggestions (ML-powered)
  ANALYTICS              # Advanced usage analytics dashboard
  AUTOMATION             # Automated inventory tracking and alerts
  FAMILY_SHARING         # Multi-user family collaboration
  PRICE_ALERTS           # Price drop notifications
}

# ========================================
# QUERIES
# ========================================

extend type Query {
  """
  Get trial progress for current user.
  Returns null if user is not on trial.
  """
  trialProgress: TrialProgress
  
  """
  Get feature access for current user.
  Returns access levels for all premium features.
  Used to show/hide premium UI and upgrade prompts.
  """
  featureAccess: [FeatureAccess!]!
  
  """
  Check if specific feature is accessible for current user.
  Returns access level and usage limits if applicable.
  """
  checkFeatureAccess(featureKey: PremiumFeature!): FeatureAccess!
  
  """
  Get onboarding status and remaining steps.
  Used during trial days 1-3 for guided feature exploration.
  """
  onboardingStatus: OnboardingStatus!
  
  """
  Calculate value metrics for trial period.
  Aggregates usage events into quantified value (time saved, conflicts prevented).
  """
  trialValueMetrics: TrialValueMetrics!
}

"""Onboarding completion status"""
type OnboardingStatus {
  completed: Boolean!
  stepsCompleted: Int!
  stepsTotal: Int!
  percentComplete: Float!
  remainingSteps: [OnboardingStep!]!
  currentStep: OnboardingStep
}

"""Aggregated value metrics for trial dashboard"""
type TrialValueMetrics {
  timeSavedHours: Float!
  timeSavedValue: Float!  # Hours * hourly rate for comparison
  conflictsPrevented: Int!
  conflictsValue: String!  # "Saved you 3 stressful moments"
  suggestionsAccepted: Int!
  automationsTriggered: Int!
  valueScore: Int!
  comparisonToFree: String!  # "2.5x more efficient than free tier"
}

# ========================================
# MUTATIONS
# ========================================

extend type Mutation {
  """
  Track premium feature usage during trial.
  Records engagement and calculates value impact.
  
  Requirements:
  - User must have active trial (status = TRIALING)
  - Feature must be premium feature
  - Value impact must be quantifiable
  
  Constitutional Alignment:
  - Principle 1: Visual progress reduces cognitive load
  - Principle 10: Real-time feedback for value demonstration
  """
  trackFeatureUsage(input: FeatureUsageInput!): FeatureUsageResult!
  
  """
  Complete onboarding step during trial.
  Marks step as completed and advances onboarding progress.
  Unlocks next guided tutorial if available.
  
  Requirements:
  - User must be on trial
  - Step must be part of onboarding sequence
  """
  completeOnboardingStep(stepId: String!): OnboardingStepResult!
  
  """
  Dismiss conversion prompt during trial.
  Tracks prompt dismissals to avoid aggressive prompting.
  Maximum 3 prompts during 14-day trial (days 10, 12, 14).
  
  Constitutional Alignment:
  - Principle 2: Stress reduction (no aggressive sales tactics)
  - Principle 3: Canadian trust-building (respectful prompting)
  """
  dismissConversionPrompt: DismissPromptResult!
  
  """
  Request trial extension.
  Allows users to request additional evaluation time.
  Implementation details deferred to tasks phase (FR-015).
  
  Requirements:
  - User must be on active trial
  - Trial must be near expiration (last 3 days)
  - Extension limit TBD in tasks phase
  """
  requestTrialExtension(reason: String): TrialExtensionResult!
}

# ========================================
# MUTATION INPUTS
# ========================================

"""Input for tracking feature usage"""
input FeatureUsageInput {
  featureKey: PremiumFeature!
  eventType: FeatureEventType!
  valueImpact: ValueImpactInput!
  sessionId: String
}

"""Types of feature usage events"""
enum FeatureEventType {
  FEATURE_USED          # User activated premium feature
  TIME_SAVED            # Automation saved user time
  CONFLICT_PREVENTED    # Smart detection prevented scheduling conflict
  SUGGESTION_ACCEPTED   # User accepted ML-powered suggestion
  AUTOMATION_TRIGGERED  # Automated action completed
}

"""Quantified value impact of feature usage"""
input ValueImpactInput {
  timeSavedMinutes: Int
  conflictsPrevented: Int
  suggestionsAccepted: Int
  automationsTriggered: Int
}

# ========================================
# MUTATION RESULTS
# ========================================

"""Result of feature usage tracking"""
type FeatureUsageResult {
  success: Boolean!
  trialProgress: TrialProgress
  updatedMetrics: TrialValueMetrics
  error: Error
}

"""Result of onboarding step completion"""
type OnboardingStepResult {
  success: Boolean!
  onboardingStatus: OnboardingStatus
  nextStep: OnboardingStep
  error: Error
}

"""Result of dismissing conversion prompt"""
type DismissPromptResult {
  success: Boolean!
  promptsRemaining: Int!
  nextPromptDate: DateTime
  error: Error
}

"""Result of trial extension request"""
type TrialExtensionResult {
  success: Boolean!
  approved: Boolean!
  extensionDays: Int
  newTrialEnd: DateTime
  message: String
  error: Error
}

# ========================================
# SUBSCRIPTIONS (Real-Time Updates)
# ========================================

extend type Subscription {
  """
  Real-time trial progress updates.
  Emits when value metrics change or onboarding steps completed.
  Used for live trial dashboard updates.
  """
  trialProgressUpdated(userId: ID!): TrialProgress!
}

# ========================================
# TRIAL VALUE CALCULATION LOGIC
# ========================================

"""
Value Score Algorithm (0-100):

1. Time Saved Weight: 40 points
   - 0-15 minutes: 0 points
   - 16-60 minutes: 20 points
   - 61-120 minutes: 30 points
   - 121+ minutes: 40 points

2. Conflicts Prevented Weight: 30 points
   - 0 conflicts: 0 points
   - 1 conflict: 10 points
   - 2 conflicts: 20 points
   - 3+ conflicts: 30 points

3. Feature Exploration Weight: 20 points
   - Features explored / total features * 20
   - 5 features total (reorder, analytics, automation, family_sharing, price_alerts)

4. Engagement Weight: 10 points
   - Sessions / 14 days * 10 (max 10 points at 1 session/day)

Conversion Eligibility:
- Value Score >= 60 AND
- Days Active >= 8 AND
- Features Explored >= 3

Target: 85% of converting users cite specific value (success metric from spec)
"""

# ========================================
# CONVERSION PROMPT TIMING
# ========================================

"""
Gentle Conversion Prompts (FR-014):
- Day 10: "You've saved X hours - continue with premium?"
- Day 12: "Only 2 days left in trial - secure your premium features"
- Day 14: "Last day! Don't lose your progress - upgrade now"

Requirements:
- Maximum 3 prompts during trial
- User can dismiss with no penalty
- Prompts show quantified value, not urgency
- No aggressive countdown timers or pressure tactics

Constitutional Alignment:
- Principle 2: Stress reduction through supportive messaging
- Principle 3: Canadian trust-building (no dark patterns)
"""

